<section class="ft-page">

  <!-- ── Top Legend ─────────────────────────── -->
  <div class="ft-legend-bar">
    <div class="ft-legend-bar__inner">
      <span class="legend-item">
        <span class="legend-dot legend-dot--ga"></span>GA Type
      </span>
      <span class="legend-item">
        <span class="legend-dot legend-dot--type1"></span>Agent Type 1
      </span>
      <span class="legend-item">
        <span class="legend-dot legend-dot--type2"></span>Agent Type 2
      </span>
    </div>

    <div class="ft-legend-bar__actions">
      <div class="ft-search">
        <svg class="ft-search__icon" xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24"
          fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="11" cy="11" r="8" />
          <path d="m21 21-4.35-4.35" />
        </svg>
        <input class="ft-search__input" type="text" placeholder="ค้นหาชื่อ, รหัส..." [value]="searchQuery()"
          (input)="searchQuery.set($any($event.target).value)" />
        @if (searchQuery()) {
        <button class="ft-search__clear" (click)="searchQuery.set('')">✕</button>
        }
      </div>
      <button class="ft-top-btn" (click)="fetchFamilyTree()" title="รีเฟรช">
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8" />
          <path d="M21 3v5h-5" />
          <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16" />
          <path d="M8 16H3v5" />
        </svg>
      </button>
      <button class="ft-top-btn ft-top-btn--primary" (click)="toggleExpandAll()">
        {{ expandAll() ? 'ย่อทั้งหมด' : 'ขยายทั้งหมด' }}
      </button>
    </div>
  </div>

  <!-- ── Stats bar ──────────────────────────── -->
  @if (!loading() && !error()) {
  <div class="ft-stats-bar">
    <span class="ft-stats-bar__item">
      <b>{{ totalMembers() }}</b> สมาชิกทั้งหมด
    </span>
  </div>
  }

  <!-- ── Canvas ─────────────────────────────── -->
  <div class="ft-canvas">
    @if (loading()) {
    <div class="ft-state">
      <div class="ft-spinner"></div>
      <p>กำลังโหลดข้อมูล...</p>
    </div>
    } @else if (error()) {
    <div class="ft-state">
      <p class="ft-state--error">{{ error() }}</p>
      <button class="ft-top-btn ft-top-btn--primary" (click)="fetchFamilyTree()">ลองใหม่</button>
    </div>
    } @else if (filteredTree().length === 0) {
    <div class="ft-state">
      <p>ไม่พบข้อมูลที่ค้นหา</p>
      <button class="ft-top-btn" (click)="searchQuery.set('')">ล้างการค้นหา</button>
    </div>
    } @else {
    <div class="ft-org">
      @for (root of filteredTree(); track root.id) {
      <ng-container *ngTemplateOutlet="nodeTemplate; context: { $implicit: root, depth: 0 }" />
      }
    </div>
    }
  </div>
</section>

<!-- ── Recursive Node Template ────────────────── -->
<ng-template #nodeTemplate let-node let-depth="depth">
  <div class="ft-org-node" [class.ft-org-node--root]="depth === 0">

    <!-- Card -->
    <div class="ft-card" [class]="'ft-card--' + getTypeKey(node.type)">
      <!-- Type label row -->
      <div class="ft-card__type-row" [class]="'ft-card__type-row--' + getTypeKey(node.type)">
        <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2" />
          <circle cx="12" cy="7" r="4" />
        </svg>
        <span>{{ node.type | uppercase }}</span>
      </div>

      <!-- Name -->
      <div class="ft-card__name">{{ node.title }} {{ node.firstName }} {{ node.lastName }}</div>

      <!-- Agent ID -->
      <div class="ft-card__agent-id">
        @if (node.agentId) { {{ node.agentId }} } @else { — }
      </div>

      <!-- Status dot -->
      <div class="ft-card__status-row">
        <span class="ft-card__status-dot" [class]="'ft-card__status-dot--' + getStatusKey(node.checkedStatus)"></span>
        <span class="ft-card__status-label">{{ getStatusLabel(node.checkedStatus) }}</span>
      </div>

      <!-- Contract summary -->
      <div class="ft-card__divider"></div>
      @if (node.contracts && node.contracts.length > 0) {
      <button class="ft-card__contracts-btn" (click)="openPanel(node)">
        <div class="ft-card__contracts-stats">
          <span class="ft-card__contracts-count">
            <svg xmlns="http://www.w3.org/2000/svg" width="11" height="11" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
              <polyline points="14 2 14 8 20 8" />
            </svg>
            {{ node.contracts.length }} สัญญา
          </span>
          <span class="ft-card__contracts-amount">
            ฿{{ formatAmount(getTotalAmount(node.contracts)) }}
          </span>
        </div>
        <span class="ft-card__contracts-view">ดูรายละเอียด →</span>
      </button>
      } @else {
      <div class="ft-card__no-contracts">ไม่มีสัญญา</div>
      }

      <!-- Team summary value -->
      @if (node.summaryTeamValue > 0) {
      <div class="ft-card__team-value">
        <div class="ft-card__team-value-label">
          <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
            <circle cx="9" cy="7" r="4" />
            <path d="M23 21v-2a4 4 0 0 0-3-3.87" />
            <path d="M16 3.13a4 4 0 0 1 0 7.75" />
          </svg>
          ยอดทีม
        </div>
        <span class="ft-card__team-value-amount">฿{{ formatAmount(node.summaryTeamValue) }}</span>
      </div>
      }

      <!-- Expand toggle -->
      @if (node.children.length > 0) {
      <button class="ft-card__toggle" [class.ft-card__toggle--open]="!node.collapsed" (click)="toggleNode(node)"
        [attr.aria-label]="node.collapsed ? 'ขยาย' : 'ย่อ'">
        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
          <path d="m6 9 6 6 6-6" />
        </svg>
      </button>
      }
    </div>

    <!-- Children branch -->
    @if (node.children.length > 0 && !node.collapsed) {
    <div class="ft-org-children">
      <div class="ft-connector ft-connector--down"></div>
      <div class="ft-connector-row">
        @for (child of node.children; track child.id; let first = $first; let last = $last) {
        <div class="ft-connector-col" [class.ft-connector-col--first]="first" [class.ft-connector-col--last]="last"
          [class.ft-connector-col--single]="node.children.length === 1">
          <div class="ft-connector ft-connector--up"></div>
          <ng-container *ngTemplateOutlet="nodeTemplate; context: { $implicit: child, depth: depth + 1 }" />
        </div>
        }
      </div>
    </div>
    }
  </div>
</ng-template>

<!-- ── Contract Detail Side Panel ────────────────── -->
<div class="ft-panel-backdrop" [class.ft-panel-backdrop--open]="panelOpen()" (click)="closePanel()"></div>
<aside class="ft-panel" [class.ft-panel--open]="panelOpen()">
  @if (selectedMember()) {

  <!-- Header -->
  <div class="ft-panel__header" [class]="'ft-panel__header--' + getTypeKey(selectedMember()!.type)">
    <div class="ft-panel__header-info">
      <div class="ft-panel__header-type">{{ selectedMember()!.type | uppercase }}</div>
      <div class="ft-panel__header-name">{{ selectedMember()!.title }} {{ selectedMember()!.firstName }} {{
        selectedMember()!.lastName }}</div>
      <div class="ft-panel__header-id">{{ selectedMember()!.agentId ?? '—' }}</div>
    </div>
    <button class="ft-panel__close" (click)="closePanel()">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
        stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
        <path d="M18 6 6 18" />
        <path d="m6 6 12 12" />
      </svg>
    </button>
  </div>

  <!-- Summary strip -->
  <div class="ft-panel__summary">
    <div class="ft-panel__summary-item">
      <span class="ft-panel__summary-label">จำนวนสัญญา</span>
      <span class="ft-panel__summary-value">{{ selectedMember()!.contracts.length }}</span>
    </div>
    <div class="ft-panel__summary-item">
      <span class="ft-panel__summary-label">มูลค่ารวม</span>
      <span class="ft-panel__summary-value ft-panel__summary-value--amount">
        {{ formatAmountFull(getTotalAmount(selectedMember()!.contracts)) }}
      </span>
    </div>
  </div>

  <!-- Contract flat list -->
  <div class="ft-panel__list">
    @if (selectedMember()!.contracts.length === 0) {
    <div class="ft-panel__empty">
      <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none"
        stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="color:#d1d5db">
        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
        <polyline points="14 2 14 8 20 8" />
      </svg>
      <p>ไม่มีข้อมูลสัญญา</p>
    </div>
    }

    @for (c of selectedMember()!.contracts; track c.contractNumber; let idx = $index) {
    <div class="ft-panel__item">
      <!-- Contract row: number + status -->
      <div class="ft-panel__item-row">
        <span class="ft-panel__item-number">{{ c.contractNumber }}</span>
        <span class="ft-panel__item-badge" [class]="'ft-panel__item-badge--' + getContractStatusKey(c.status)">
          {{ c.status === 'active' ? 'Active' : c.status }}
        </span>
      </div>

      <!-- Detail grid -->
      <div class="ft-panel__item-details">
        <div class="ft-panel__item-kv">
          <span class="ft-panel__item-key">ผลิตภัณฑ์</span>
          <span class="ft-panel__item-val">{{ c.productCode }}</span>
        </div>
        <div class="ft-panel__item-kv">
          <span class="ft-panel__item-key">นักลงทุน</span>
          <span class="ft-panel__item-val">{{ c.investorId }}</span>
        </div>
        <div class="ft-panel__item-kv">
          <span class="ft-panel__item-key">มูลค่า</span>
          <span class="ft-panel__item-val ft-panel__item-val--amount">{{ formatAmountFull(c.amount) }}</span>
        </div>
        <div class="ft-panel__item-kv">
          <span class="ft-panel__item-key">ระยะเวลา</span>
          <span class="ft-panel__item-val">{{ c.contractPeriod }} เดือน</span>
        </div>
        <div class="ft-panel__item-kv">
          <span class="ft-panel__item-key">เริ่มต้น</span>
          <span class="ft-panel__item-val">{{ c.startDate }}</span>
        </div>
        <div class="ft-panel__item-kv">
          <span class="ft-panel__item-key">สิ้นสุด</span>
          <span class="ft-panel__item-val">{{ c.endDate }}</span>
        </div>
      </div>
    </div>
    }
  </div>
  }
</aside>