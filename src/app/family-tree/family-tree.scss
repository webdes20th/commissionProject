// ─── Design tokens ──────────────────────────────────────────────────────────
$color-type1: #2563eb; // blue  — Agent Type 1
$color-type2: #059669; // green — Agent Type 2
$color-ga: #7c3aed; // purple — GA Type
$color-default: #64748b;

$bg-page: #f0f2f7;
$bg-card: #ffffff;
$border-radius: 12px;
$connector: #adb5bd;
$line-w: 2px;

// ─── Page ───────────────────────────────────────────────────────────────────
.ft-page {
    min-height: 100vh;
    background-color: $bg-page;
    background-image: radial-gradient(circle, #c5cae9 1px, transparent 1px);
    background-size: 24px 24px;
    font-family: 'Sarabun', 'Inter', sans-serif;
    color: #1e293b;
}

// ─── Legend / Toolbar bar ────────────────────────────────────────────────────
.ft-legend-bar {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 24px;
    flex-wrap: wrap;
    padding: 14px 32px;
    background: rgba(255, 255, 255, 0.85);
    backdrop-filter: blur(8px);
    border-bottom: 1px solid rgba(0, 0, 0, 0.07);
    position: sticky;
    top: 0;
    z-index: 100;

    &__inner {
        display: flex;
        align-items: center;
        gap: 24px;
        flex: 1;
        justify-content: center;
    }

    &__actions {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-shrink: 0;
    }
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 7px;
    font-size: 0.85rem;
    font-weight: 500;
    color: #374151;
}

.legend-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;

    &--ga {
        background: $color-ga;
    }

    &--type1 {
        background: $color-type1;
    }

    &--type2 {
        background: $color-type2;
    }
}

// ─── Stats bar ───────────────────────────────────────────────────────────────
.ft-stats-bar {
    text-align: center;
    padding: 6px;
    font-size: 0.78rem;
    color: #64748b;

    b {
        font-weight: 700;
        color: #374151;
    }
}

// ─── Search ──────────────────────────────────────────────────────────────────
.ft-search {
    position: relative;
    display: flex;
    align-items: center;

    &__icon {
        position: absolute;
        left: 10px;
        color: #94a3b8;
        pointer-events: none;
    }

    &__input {
        padding: 7px 32px 7px 30px;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
        background: #fff;
        font-size: 0.8rem;
        font-family: inherit;
        color: #1e293b;
        outline: none;
        width: 200px;
        transition: border-color 0.2s, box-shadow 0.2s;

        &::placeholder {
            color: #94a3b8;
        }

        &:focus {
            border-color: $color-type1;
            box-shadow: 0 0 0 3px rgba($color-type1, 0.12);
        }
    }

    &__clear {
        position: absolute;
        right: 8px;
        background: none;
        border: none;
        cursor: pointer;
        color: #94a3b8;
        font-size: 0.75rem;
        padding: 2px;

        &:hover {
            color: #374151;
        }
    }
}

// ─── Buttons ──────────────────────────────────────────────────────────────────
.ft-top-btn {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 7px 14px;
    border-radius: 8px;
    font-size: 0.8rem;
    font-weight: 500;
    font-family: inherit;
    cursor: pointer;
    border: 1px solid #e2e8f0;
    background: #fff;
    color: #374151;
    transition: all 0.18s;
    white-space: nowrap;

    &:hover {
        background: #f8fafc;
        border-color: #cbd5e1;
    }

    &--primary {
        background: $color-type1;
        color: #fff;
        border-color: $color-type1;

        &:hover {
            background: darken($color-type1, 6%);
        }
    }
}

// ─── Canvas ───────────────────────────────────────────────────────────────────
.ft-canvas {
    padding: 40px 32px 80px;
    min-height: calc(100vh - 80px);
    overflow-x: auto;
    overflow-y: auto;
    // Allow the inner tree to report its full intrinsic width so
    // overflow-x: auto can scroll in BOTH directions (not just right).
    // Without this the left half of a wide tree is clipped and unreachable.
    text-align: center;
}

.ft-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 16px;
    min-height: 50vh;
    text-align: center;
    font-size: 0.95rem;
    color: #64748b;

    &--error {
        color: #dc2626;
    }
}

.ft-spinner {
    width: 40px;
    height: 40px;
    border: 3px solid rgba($color-type1, 0.15);
    border-top-color: $color-type1;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
}

@keyframes spin {
    to {
        transform: rotate(360deg);
    }
}

// ─── Org tree layout ──────────────────────────────────────────────────────────
.ft-org {
    // Use inline-flex so the element's scroll width equals its content width.
    // With display:flex + align-items:center the browser centres in the
    // viewport but doesn't mark the left overflow as scrollable — cards on
    // the left get permanently clipped. inline-flex fixes that.
    display: inline-flex;
    flex-direction: column;
    align-items: center;
    gap: 0;
    // Ensures the canvas scroll container sees at least the full tree width.
    min-width: max-content;
    padding: 0 40px; // extra breathing room on both sides when scrolling
}

// A single node + its subtree
.ft-org-node {
    display: flex;
    flex-direction: column;
    align-items: center;
}

// Children container
.ft-org-children {
    display: flex;
    flex-direction: column;
    align-items: center;
}

// The horizontal row of child columns
.ft-connector-row {
    display: flex;
    flex-direction: row;
    align-items: flex-start;
    position: relative;

    // The horizontal bar across all siblings
    &::before {
        content: '';
        position: absolute;
        top: 0;
        left: 50%;
        right: 50%;
        height: $line-w;
        background: $connector;
    }
}

// Dynamically extend the horizontal bar
// We use the first and last child pseudo-elements to extend
.ft-connector-col {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 0 16px;
    position: relative;

    // Draw horizontal bar only for multi-child rows
    &:not(.ft-connector-col--single) {

        // Each col's top has the horizontal line
        &::before {
            content: '';
            position: absolute;
            top: 0;
            height: $line-w;
            background: $connector;
            left: 0;
            right: 0;
        }

        // But first column only draws right half
        &.ft-connector-col--first::before {
            left: 50%;
            right: 0;
        }

        // And last column only draws left half
        &.ft-connector-col--last::before {
            left: 0;
            right: 50%;
        }
    }
}

// Vertical connector — going DOWN from card
.ft-connector--down {
    width: $line-w;
    height: 28px;
    background: $connector;
    flex-shrink: 0;
}

// Vertical connector — going UP into card (inside each child column)
.ft-connector--up {
    width: $line-w;
    height: 28px;
    background: $connector;
    flex-shrink: 0;
}

// ─── Card ─────────────────────────────────────────────────────────────────────
.ft-card {
    background: $bg-card;
    border-radius: $border-radius;
    border: 2px solid $color-default;
    width: 200px;
    padding: 12px 14px 10px;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.07);
    transition: box-shadow 0.2s, transform 0.2s;
    cursor: default;
    position: relative;

    &:hover {
        box-shadow: 0 6px 24px rgba(0, 0, 0, 0.13);
        transform: translateY(-2px);
    }

    // Color variants
    &--type1 {
        border-color: $color-type1;
    }

    &--type2 {
        border-color: $color-type2;
    }

    &--ga {
        border-color: $color-ga;
    }

    // ── Type label row ──
    &__type-row {
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 0.64rem;
        font-weight: 700;
        letter-spacing: 0.06em;
        color: $color-default;
        margin-bottom: 6px;

        svg {
            flex-shrink: 0;
        }

        &--type1 {
            color: $color-type1;

            svg {
                stroke: $color-type1;
            }
        }

        &--type2 {
            color: $color-type2;

            svg {
                stroke: $color-type2;
            }
        }

        &--ga {
            color: $color-ga;

            svg {
                stroke: $color-ga;
            }
        }
    }

    // ── Name ──
    &__name {
        font-size: 0.85rem;
        font-weight: 600;
        color: #1e293b;
        line-height: 1.35;
        margin-bottom: 4px;
        word-break: break-word;
    }

    // ── Agent ID ──
    &__agent-id {
        font-size: 0.75rem;
        color: #64748b;
        margin-bottom: 6px;
        font-family: 'SFMono-Regular', 'Consolas', monospace;
    }

    // ── Status ──
    &__status-row {
        display: flex;
        align-items: center;
        gap: 5px;
        margin-bottom: 2px;
    }

    &__status-dot {
        width: 7px;
        height: 7px;
        border-radius: 50%;
        flex-shrink: 0;

        &--active {
            background: #22c55e;
        }

        &--inactive {
            background: #ef4444;
        }

        &--pending {
            background: #d1d5db;
        }
    }

    &__status-label {
        font-size: 0.7rem;
        color: #64748b;
    }

    // ── Divider ──
    &__divider {
        height: 1px;
        background: #f1f5f9;
        margin: 8px 0 6px;
    }

    // ── Contract summary button ──
    &__contracts-btn {
        width: 100%;
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 7px 9px;
        cursor: pointer;
        text-align: left;
        transition: background 0.15s, border-color 0.15s;
        font-family: inherit;

        &:hover {
            background: #eff6ff;
            border-color: rgba($color-type1, 0.4);
        }
    }

    &__contracts-stats {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 3px;
    }

    &__contracts-count {
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 0.68rem;
        font-weight: 600;
        color: #374151;

        svg {
            stroke: #64748b;
            flex-shrink: 0;
        }
    }

    &__contracts-amount {
        font-size: 0.68rem;
        font-weight: 700;
        color: $color-type1;
        font-family: 'SFMono-Regular', 'Consolas', monospace;
    }

    &__contracts-view {
        display: block;
        font-size: 0.63rem;
        color: #94a3b8;
    }

    // ── No contracts ──
    &__no-contracts {
        font-size: 0.68rem;
        color: #94a3b8;
        text-align: center;
        padding: 4px 0;
    }

    // ── Team summary value ──
    &__team-value {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-top: 7px;
        padding: 6px 9px;
        background: linear-gradient(135deg, #eef2ff 0%, #f0fdf4 100%);
        border: 1px solid #c7d2fe;
        border-radius: 8px;
        gap: 6px;
    }

    &__team-value-label {
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 0.63rem;
        font-weight: 600;
        color: #6366f1;
        white-space: nowrap;
        letter-spacing: 0.03em;

        svg {
            stroke: #6366f1;
            flex-shrink: 0;
        }
    }

    &__team-value-amount {
        font-size: 0.72rem;
        font-weight: 700;
        color: #4f46e5;
        font-family: 'SFMono-Regular', 'Consolas', monospace;
        text-align: right;
    }

    // ── Expand toggle ──
    &__toggle {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        margin-top: 8px;
        border: none;
        background: none;
        cursor: pointer;
        color: #94a3b8;
        padding: 0;
        transition: color 0.15s;

        svg {
            transition: transform 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        &:hover {
            color: #374151;
        }

        &--open svg {
            transform: rotate(180deg);
        }
    }
}

// ─── Side panel backdrop ─────────────────────────────────────────────────────
.ft-panel-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(15, 23, 42, 0.35);
    z-index: 200;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s;

    &--open {
        opacity: 1;
        pointer-events: auto;
    }
}

// ─── Side panel ───────────────────────────────────────────────────────────────
.ft-panel {
    position: fixed;
    top: 0;
    right: 0;
    bottom: 0;
    width: 420px;
    max-width: 100vw;
    background: #fff;
    z-index: 201;
    display: flex;
    flex-direction: column;
    transform: translateX(100%);
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: -4px 0 32px rgba(0, 0, 0, 0.12);

    &--open {
        transform: translateX(0);
    }

    // Header
    &__header {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        padding: 20px 20px 16px;
        border-bottom: 1px solid #f1f5f9;
        flex-shrink: 0;

        &--type1 {
            border-top: 4px solid $color-type1;
        }

        &--type2 {
            border-top: 4px solid $color-type2;
        }

        &--ga {
            border-top: 4px solid $color-ga;
        }
    }

    &__header-info {
        flex: 1;
    }

    &__header-type {
        font-size: 0.65rem;
        font-weight: 700;
        letter-spacing: 0.07em;
        color: #94a3b8;
        margin-bottom: 4px;
    }

    &__header-name {
        font-size: 1.05rem;
        font-weight: 700;
        color: #1e293b;
        margin-bottom: 2px;
    }

    &__header-id {
        font-size: 0.78rem;
        color: #64748b;
        font-family: 'SFMono-Regular', 'Consolas', monospace;
    }

    &__close {
        background: none;
        border: none;
        cursor: pointer;
        color: #94a3b8;
        padding: 4px;
        border-radius: 6px;
        transition: background 0.15s, color 0.15s;
        margin-left: 8px;
        flex-shrink: 0;

        &:hover {
            background: #f1f5f9;
            color: #374151;
        }
    }

    // Summary strip
    &__summary {
        display: flex;
        gap: 0;
        border-bottom: 1px solid #f1f5f9;
        flex-shrink: 0;
    }

    &__summary-item {
        flex: 1;
        padding: 12px 20px;
        border-right: 1px solid #f1f5f9;

        &:last-child {
            border-right: none;
        }
    }

    &__summary-label {
        display: block;
        font-size: 0.68rem;
        color: #94a3b8;
        margin-bottom: 3px;
    }

    &__summary-value {
        display: block;
        font-size: 1.1rem;
        font-weight: 700;
        color: #1e293b;

        &--amount {
            color: $color-type1;
            font-family: 'SFMono-Regular', 'Consolas', monospace;
            font-size: 0.9rem;
        }
    }

    // ── Flat contract list ──────────────────────────
    &__list {
        flex: 1;
        overflow-y: auto;
        padding: 0;
        // Custom scrollbar
        scrollbar-width: thin;
        scrollbar-color: #e2e8f0 transparent;

        &::-webkit-scrollbar {
            width: 5px;
        }

        &::-webkit-scrollbar-thumb {
            background: #e2e8f0;
            border-radius: 99px;
        }
    }

    &__empty {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
        text-align: center;
        color: #94a3b8;
        font-size: 0.85rem;
        padding: 48px 0;

        p {
            margin: 0;
        }
    }

    // Each flat contract row
    &__item {
        border-bottom: 1px solid #f1f5f9;

        &:last-child {
            border-bottom: none;
        }
    }

    // Top row: contract number + badge
    &__item-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 20px 8px;
    }

    &__item-number {
        font-size: 0.82rem;
        font-weight: 700;
        color: #1e293b;
        font-family: 'SFMono-Regular', 'Consolas', monospace;
        letter-spacing: 0.02em;
    }

    &__item-badge {
        font-size: 0.63rem;
        font-weight: 600;
        padding: 2px 9px;
        border-radius: 20px;
        flex-shrink: 0;

        &--active {
            background: #dcfce7;
            color: #16a34a;
        }

        &--inactive {
            background: #fee2e2;
            color: #dc2626;
        }
    }

    // Detail grid below the number row
    &__item-details {
        padding: 0 20px 12px;
        display: grid;
        grid-template-columns: auto 1fr;
        gap: 3px 12px;
    }

    &__item-kv {
        display: contents;
    }

    &__item-key {
        font-size: 0.68rem;
        color: #94a3b8;
        align-self: center;
        white-space: nowrap;
    }

    &__item-val {
        font-size: 0.72rem;
        color: #374151;
        font-weight: 500;
        text-align: right;
        align-self: center;
        word-break: break-word;

        &--amount {
            color: $color-type1;
            font-weight: 700;
            font-family: 'SFMono-Regular', 'Consolas', monospace;
        }
    }
}

// ─── Responsive ───────────────────────────────────────────────────────────────
@media (max-width: 640px) {
    .ft-canvas {
        padding: 24px 8px 60px;
    }

    .ft-legend-bar {
        padding: 12px 16px;
        gap: 12px;
    }

    .ft-connector-col {
        padding: 0 8px;
    }

    .ft-card {
        width: 170px;
    }

    .ft-panel {
        width: 100vw;
    }

    .ft-search__input {
        width: 140px;
    }
}